<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Footy</title>

  <script src="libraries/p5.js" type="text/javascript"></script>
  <script src="libraries/p5.min.js" type="text/javascript"></script>
  <script src="libraries/p5.dom.js" type="text/javascript"></script>
  <script src="/socket.io/socket.io.js" type="text/javascript"></script>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js" type="text/javascript"></script>
  <script src="guidGenerator.js" type="text/javascript"></script>
  <script src="shot.js" type="text/javascript"></script>
  <script>
    $(function () {
      var socket = io();
      $('form').submit(function() {
        socket.emit('message', $('#m').val());
        $('#m').val('');
        return false;
      });

      // Client message
      socket.on('messageClient', function(msg) {
        var temp = msg.valueOf();
        var messageHtml = '<li class="self">' + '<div class="msg">' +
                          '<p>' + temp + '</p>' + '</li>';
        $('#messages').append(messageHtml);
      });

      // Server message
      socket.on('messageServer', function(msg) {
        var temp = msg.valueOf();
        var messageHtml = '<li class="other">' + '<div class="msg">' +
                          '<p>' + temp + '</p>' + '</li>';
        $('#messages').append(messageHtml);
      });

      // List
      socket.on('messageServerList', function(msg) {
        var temp = msg.valueOf();
        var messageHtml = '<li class="other">' + '<div class="msg">' +
                          '<p>' + temp + '</p>' + '</li>';
        $('#messages').append(messageHtml);
      });

      // Map
      socket.on('messageServerMap', function(msg) {
        var obj = JSON.parse(msg);
        var objLength = Object.keys(obj).length;
        div_id = guidGenerator();
        // Scrivi di GUID:
        // https://en.wikipedia.org/wiki/Universally_unique_identifier
        console.log(msg.valueOf());
        var messageHtml = '<li class="other">' + '<div class="msg" id="map-' + div_id + '">';
        messageHtml += '</li>';
        $('#messages').append(messageHtml);

        var sketch = function(p) {
          var img;
          var shots = [];

          p.preload = function() {
            img = p.loadImage("assets/football_pitch.png");
          }

          p.setup = function() {
            p.createCanvas(534, 356);
            p.background(img);

            for (var i = 0; i < objLength; i++) {
              shots.push(new Shot(obj[i].x + Math.random() * 534 / 2,
                                  obj[i].y + Math.random() * 534 / 2,
                                  obj[i].distance, obj[i].angle, obj[i].scored));
            }

            for (var i = 0; i < objLength; i++) {
              shots[i].display();
            }
          }

          function Shot(_x, _y, _distance, _angle, _scored) {
            this.x = _x;
            this.y = _y;
            this.distance = _distance;
            this.angle = _angle;
            this.scored = _scored;
          }

          Shot.prototype.display = function() {
            // xG in percentuale.
            var xG = p.constrain(this.expectedQuality(this.x, this.y) * 100, 5, 20);
            p.stroke(0);
            if (this.scored) {
              p.fill(120);
              p.ellipse(this.x, this.y, xG, xG);
            } else {
              p.fill(255);
              p.ellipse(this.x, this.y, xG, xG);
            }
          }

          Shot.prototype.expectedQuality = function(x, y) {
            // 68  -> larghezza campo in metri
            // 105 -> lunghezza campo in metri
            // 356 -> larghezza campo in pixel
            // 534 -> lunghezza campo in pixel

            // 5.1 -> px per m (5.1px = 1m)
            // 201 -> palo dx (campo sx)
            // 152 -> palo sx (campo sx)
            //

            var pitchX 		    = x * 68 / 356,
                pitchY 		    = y * (105 / 2) / 534,
                leftPostXY 	  = [152 * 68 / 356, 0 * (105 / 2) / (534 / 2)],
                rightPostXY 	= [201 * 68 / 356, 0 * (105 / 2) / (534 / 2)],
                centreGoalXY 	= [152 + ((201 - 152) / 2) * 68 / 356, 0 * (105 / 2) / (534 / 2)],
                goalWidth 	  = 49 * 68 / 356;

            if (x < (534 / 2)) {
              var distNearPost = Math.sqrt(Math.pow(pitchX - leftPostXY[0], 2)  + Math.pow(pitchY - leftPostXY[1], 2)),
                  distFarPost  = Math.sqrt(Math.pow(pitchX - rightPostXY[0], 2) + Math.pow(pitchY - rightPostXY[1], 2));
            } else {
              var distFarPost  = Math.sqrt(Math.pow(pitchX - leftPostXY[0], 2)  + Math.pow(pitchY - leftPostXY[1], 2)),
                  distNearPost = Math.sqrt(Math.pow(pitchX - rightPostXY[0], 2) + Math.pow(pitchY - rightPostXY[1], 2));
            }
            // Angolo della posizione del tiro e i due pali utilizzando il teorema del coseno.
            var goalAngle = Math.acos((Math.pow(distNearPost, 2) + Math.pow(distFarPost, 2) - Math.pow(goalWidth, 2)) / (2 * distNearPost * distFarPost));
            // Distanza tra la posizione del tiro e il centro della porta.
            var goalDistance = Math.sqrt(Math.pow(centreGoalXY[0] - pitchX, 2) + Math.pow(centreGoalXY[1] - pitchY, 2));

            var xG = 1 / (1 + Math.exp(-(-1.7 + 1.338737 * goalAngle - 0.110384 * goalDistance + 0.168798 * goalAngle * goalDistance)));
            console.table({ name:"xG", value: xG, name: "x", value: x, name: "y", value: y, name: "distance", value: goalDistance});
            return xG;
          }

        };
        new p5(sketch, 'map-' + div_id);
      });

      // Plot
      socket.on('messageServerPlot', function(msg) {
        var temp = msg.valueOf();
        var messageHtml = '<li class="other">' + '<div class="msg">' +
                          '<p>' + temp + '</p>' + '</li>';
        $('#messages').append(messageHtml);
      });
      /* End */
    });
  </script>

  <link href="assets/football.ico" rel="shortcut icon" type="image/ico">
  <link href="style.css" rel="stylesheet" type="text/css">

</head>
<body>
  <div class="menu"><div class="name">Soccer Bot</div></div>
  <ol id="messages" class="chat">
    <li class="other">
      <div class="msg">
        <p>Hi!</p>
        <p>Type <b>help</b> for an expanded list of commands.</p>
      </div>
    </li>
  </ol>
  <form action="">
    <input id="m" class="textarea" type="text" placeholder="Type here!" autocomplete="off">
  </form>
</body>
</html>
